<?php    session_start();?><!DOCTYPE html><html id="topanchor"><head>    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <title>Culturemania - Espace Rédaction</title>    <meta name="description" content="Site de la culture autour des jeux video, des livres et BD, des films et des séries TV, des lieux culturels, de la musique et des sites internet. Culturemania"/>    <meta name="keywords" content="jeux, jeu, video, livre, livres, film, films, serie, series, TV, télé, lieux, musique, album, artiste, concert, culture, mania, evenement, console, ps3, ps4, xbox, cinema, PC, actualité"/>    <meta property="og:image" content="http://www.culturemania.fr/assets/culturemania.jpg" />    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>    <meta name="viewport" content="width=device-width">    <meta name="viewport" content="initial-scale=1.0">    <link rel="stylesheet" href="/style.css"/>    <link rel="stylesheet" media="screen and (max-width: 1220px)" href="/style-1200.css"/>    <link rel="stylesheet" media="screen and (max-width: 1020px)" href="/style-1000.css"/>    <link rel="stylesheet" media="screen and (max-width: 620px)" href="/style-600.css"/></head><body><div class="cm-margin-150"></div><div class="backgroundBlack" id="id-bg" onclick="javascript: hideBoxes();"></div><div class="cm-main" id="id-preview">	<h1>Aperçu de votre article</h1>	<div class="cm-separator-double"></div>	<BR><BR>	<article class="cm-article">		<div class="cm-news-75">			<div class="cm-intro" id="cm-intro-text"></div>			<div class="cm-separator-double"></div>			<div class="cm-article-texte">				<div id="cm-preview-text"></div>			</div>		</div>		<aside>			<div class="cm-padding-10">				<p> Ceci est un aperçu du rendu de votre article. Pour le retoucher, veuillez utiliser les boutons présents dans la zone de formattage du texte. Vous pouvez créer des paragraphes en sélectionnant le texte et en cliquant sur le bouton de création du paragraphe, passer du texte en gras, rajouter des images, des citations, etc</p>			</div>		</aside>	</article></div>    <?php        include 'connect.php';        include 'session.php';         setlocale (LC_TIME, 'fr_FR.utf8','fra');         include 'menu.php';         include 'CArticle.php';            ?><section class="cm-section">    <div class="cm-main">        <div class="cm-glass-main">            <article class="cm-article">   <?php    $titre = "";    $intro_form = "";    $article_form = "";    $intro = "";    $chronique = "";    $email = "";    $web = "";    $idsoustype = -1;        if(!empty($_POST) && isset($_POST['dontfuckwithme']) && empty($_POST['dontfuckwithme']))    {    	        $titre = strip_tags($mysql->real_escape_string($_POST['titre']));        $intro_form = $_POST['introduction'];        $intro = strip_tags($mysql->real_escape_string($_POST['introduction']));        $chronique = strip_tags($mysql->real_escape_string($_POST['article']), '<iframe>');        if (!isset($_SESSION['idcm']))        // deconnexion possible, on redonne les infos pour ne pas qu'elles soient perdues    	{    		echo '<BR><div class="cm-error-message">';            echo '<h3>Le temps de connexion de votre session est arrivé à son terme. Veuillez vous reconnecter.</h3>';            echo '<h4>tout n\'est pas perdu ! Nous avons sauvegardé les élements de votre article : </h4>';            echo '<p><strong>Titre :</strong></p>';            echo '<p>'. $titre . '</p>';            echo '<p><strong>Introduction :</strong></p>';            echo '<p>'. $intro . '</p>';            echo '<p><strong>Corps : </strong></p>';            echo '<p>'. $chronique . '</p>';            echo'</div>';    			    	}    	else    	{    		$article_form = $_POST['article'];	        $idsoustype = $_POST['categorie'];	        $web = $_POST['website'];	        $datesortie = $_POST['datepublication'];	        $date = date('Y-m-d H:i:s');	        	        $ErrorMsg = checkImages();	        if (count($ErrorMsg) > 0)	        {	            echo '<div class="cm-error-message">';	            echo '<h3>Erreur de données : </h3>';	            foreach ($ErrorMsg as $message) 	                echo '<p>' . $message . '</p>';	            echo '</div>';	        }	        else	        {	            $query = 'SELECT IDTYPE FROM soustypechronique WHERE IDSOUSTYPE = \'' . $idsoustype . '\'';	            $res = $mysql->query($query);	            $row = $res->fetch_assoc();	            $idType = $row['IDTYPE'];	            $idAuthor = $_SESSION['idauthor'];	            $request = "INSERT INTO chronique (TITLE, INTRODUCTION, TEXT, IDTYPE, IDSOUSTYPE, IDAUTHOR, DATECREATION, PUBLISHED, DATESORTIE, WEB, NBLIKES) VALUES ('$titre','$intro','$chronique', $idType , $idsoustype,  $idAuthor, '$date', 0, '$datesortie' , '$web', 0)";	            $mysql->query($request);	          	            	            $idChronique = $mysql->insert_id;	            if($idChronique > 0)	            // Insert into réussit	            {	                $resultUpload = true;   	                if (isset($_FILES['image']))	                {	                	$arrayImg = $_FILES['image'];		                $count = count($arrayImg['name']);		                for ($i=0; $i< $count; $i++)		                {		                    $size = $arrayImg['size'][$i];		                    $filename = $arrayImg['name'][$i];		                    $tmp_filename = $arrayImg['tmp_name'][$i];		            		                    if (!empty($tmp_filename))		                    {		                        $imagePath = uploadImage($tmp_filename, 'img/'.$idChronique. '/');		                        if (!empty($imagePath))		                        {		                            $res = true;		                            $res = insertImage($mysql, $idChronique, $imagePath, 2);		                            if ($res == false)		                                $resultUpload = false;		                        }		                        else		                            $resultUpload = false;		                    }		                    		                }		                }	                	            	                $cover = $_FILES['bandeauFrame'];    	                $tmp_filename = $cover['tmp_name'];	                	                $imagePath = uploadImage($tmp_filename, 'img/'.$idChronique. '/');	                if (!empty($imagePath))	                {	                    $res = insertImage($mysql, $idChronique, $imagePath, 1);	                    $srcpath = ltrim($imagePath, "/");	                    $img = resize_image($srcpath, 0.5);	                    	                    $filenamedest = $srcpath;	                    $filenamedest = str_replace('.jpg', 'medium.jpg',$filenamedest);	                    if (imagejpeg($img, $filenamedest,100))	                        $res = insertImage($mysql, $idChronique, '/' . $filenamedest, 11);	                    $img = resize_image($srcpath, 0.25);	                    $filenamedest = $srcpath;	                    $filenamedest = str_replace('.jpg', 'small.jpg', $filenamedest);	                    	                    if (imagejpeg($img, $filenamedest,100))	                        $res = insertImage($mysql, $idChronique, '/' . $filenamedest, 12);	                }	                if($resultUpload == true)	                {	                    echo '<BR><div class="cm-ok-message">';	                    echo '<h3>Chronique envoyée ! </h3>';	                    echo '<p>Votre article <strong>' . $titre .'</strong> a bien été envoyé aux services de Culturemania et ll sera publié sous peu. Vous venez aussi de recevoir un mail de confirmation à votre adresse <strong> '.$_SESSION['idcm'] .' </strong> Merci de votre contribution !</p>';	                    echo'</div>';	                    	                    // Envoi du mail	                    $subject = $_SESSION['pseudo'] . ', votre chronique est en cours de relecture';	                    $message = "<html><body>Bonjour ". $_SESSION['pseudo'] .", <BR><p>Votre chronique " . $titre . " a bien été prise en compte par Culturemania. Elle est actuellement en phase de relecture par nos services et sera en ligne sous peu. Nous vérifions l'orthographe, la grammaire et la mise en forme. Si des modifications de texte sont souhaitables, nous vous contacterons pour en discuter ensemble avant publication.</p>	<p>Merci d'avoir contribué à l'enrichissement du site. On espère vous revoir très bientôt sur <a href=\"http://www.culturemania.fr\">http://www.culturemania.fr</a></p><BR><p>Culturemania</p></body></html>";	                    $headers = 'From: CultureMania redaction@culturemania.fr' . "\r\n" ;	                    $headers .='Reply-To: '. $_SESSION['idcm'] . "\r\n" ;	                    $headers .='X-Mailer: PHP/' . phpversion();	                    $headers  = 'MIME-Version: 1.0' . "\r\n";	                    $headers .= 'Content-type: text/html; charset=UTF-8' . "\r\n";	                    $headers .= 'From: CultureMania <redaction@culturemania.fr>' . "\r\n";	                    mail($_SESSION['idcm'],$subject,$message,$headers);	                }	                else	                {	                    echo '<div class="cm-error-message">';	                    echo '<h3>Erreur lors de l\'upload des images de la chronique : '. $_POST['titre'] .'.</h3>';	                    echo'</div>';	                }	            }	            else	            {	                echo '<div class="cm-error-message">';	                echo '<h3>Erreur lors de l\'ajout en base de la chronique : '. $_POST['titre'] .'.</h3>';	                echo'</div>';	            }	        }   	    	}           }?>			<?php 				if (!isset($_SESSION['idcm']))				{					echo '<H1>Se connecter</H1>';					echo '<div class="cm-separator-double"></div>';					                    echo '<div class="cm-formulaire" id="formulaire">';										echo '<form method="POST">';					echo '<h3>E-mail :</H3>';					echo '<input type="text" name="login" maxlength="512" placeholder="Renseignez votre adresse e-mail" value="">';					echo '<H3>Mot de passe :</H3>';					echo '<input type="password" name="password" maxlength="256" placeholder="Renseignez votre mot de passe" value="">';					echo '<BR><input type="submit" value="Se connecter">';					echo '</form>';					echo '<a href="/Inscription"><i>Créer un compte</i></a>';					echo '<a href="/LostAndFound"><i>Mot de passe oublié ?</i></a>';                    echo '</div>';				}				else				{			?>								<div class="divcenter">					<H1>Espace rédaction de Culturemania</H1>                    <div class="cm-separator-double"></div>					<div class="cm-grey">Connecté avec le compte <?php echo $_SESSION['idcm']; ?> - <a href="/logout">Se déconnecter</a> </div>				</div>				<BR>                <div class="cm-formulaire" id="formulaire">				<form id="mainform" name="mainform" onsubmit="return validateForm()" method="POST" enctype="multipart/form-data">					<h3>Catégorie :</h3>					<SELECT name="categorie" size="1">					<?php						$query = '	SELECT t.LIBELLE as TYPELIBELLE, st.IDSOUSTYPE, st.LIBELLE as SOUSTYPELIBELLE, st.DESCRIPTION 									FROM typechronique t, soustypechronique st 									where t.idtype = st.idtype									order by t.idtype, idsoustype ';						$addedtype = "";                        $res = $mysql->query($query);						while ($row = $res->fetch_assoc()) 						{							$type = $row['TYPELIBELLE'];							if ($type != $addedtype)							{								$addedtype = $type;								echo '<optgroup label="'.$addedtype.'"/>';							}														if ($idsoustype == $row['IDSOUSTYPE'])								echo '<option value="'. $row['IDSOUSTYPE'] .'" selected>'.$row['SOUSTYPELIBELLE'];							else								echo '<option value="'. $row['IDSOUSTYPE'] .'">'.$row['SOUSTYPELIBELLE'];						}												$res->close();											?>					</SELECT>					<h3>Titre :</h3>					<input type="text" name="titre" maxlength="512" placeholder="Renseignez le titre de votre article..." value="<?php echo $titre;?>">                    <h3>Couverture de l'article :</h3>                    <input type="file" name="bandeauFrame" id="bandeauFrame" accept="image/*" value="Sélectionner un bandeau"/>					<h3>Site Web :</h3>					<input type="text" name="website" maxlength="256" placeholder="Renseignez le site Web officiel..." value="<?php echo $web ?>">					<h3> Date de sortie :</h3>					<input type="date" name="datepublication">					<h3>Introduction : </h3>					<textarea rows="6" cols="40" maxlength="4096"  id="id-intro-text" placeholder="Rédigez une introduction. Celle-ci devra suffire à comprendre de quoi parle votre article mais sans trop en dire non plus..." name="introduction"><?php echo $intro_form ?></textarea>					<h3>Texte de l'article :</h3>					<textarea rows="15" cols="40" id="id-article-text" maxlength="16384" placeholder="Rédigez votre article en formattant le texte selon votre bon vouloir en utilisant les boutons situés sous cette zone de texte..." name="article" id="articleId"><?php echo $article_form ?></textarea>					                    <h3>Formattage de l'article :</h3>					<div class="cm-inline">					<input type="button" title="Créer un paragraphe pour la sélection" onclick="formatText('[P]', '[/P]');" value="Paragraphe"/>					<input type="button" title="Créer un titre pour la sélection" onclick="formatText('[T]', '[/T]');" value="Sous-titre"/>					<input type="button" title="Créer une zone de citation pour la sélection." onclick="formatText('[C]', '[/C]');" value="Citation"/>					<input type="button" title="Placer une image à l'emplacement du curseur dans le texte." onclick="formatText('[IMG]', '');" value="Image"/>					<input type="button" title="Selectionnez votre <iframe> et entourez-le avec ce tag." onclick="formatText('[VIDEO]', '[/VIDEO]');" value="Vidéo"/>					<input type="button" title="Fiche de renseignement" onclick="formatText('[F]\n[P] : [B][/B][/P][-]\n[P] : [B][/B][/P][-]\n[P] : [B][/B][/P]\n', '[/F]\n');" value="F"/>										<input type="button" title="Passer la sélection en gras" onclick="formatText('[B]', '[/B]');" value="B"/>					<input type="button" title="Passer la sélection en italique" onclick="formatText('[I]', '[/I]');" value="I"/>										<input type="button" title="Placer un retour à la ligne" onclick="formatText('[R]', '');" value="<-"/>										<input type="button" title="Inserer une URL (lien internet)" onclick="formatText('[URL=', ']]Texte du lien[/URL]');" value="www"/>					</div>                    <div class="cm-separator-double"></div>					<H3> Ajouter des Images : </H3>                    <div class="cm-info-message">                    <h3>Comment ajouter des images ?</h3>                    <BR>                    <p> C'est très simple jeune sorcier. Il suffit de cliquer sur le bouton ci-dessous <strong>[Image +1]</strong> et d'aller sélectionner ensuite un fichier image sur ton ordinateur. Il te faut ensuite passer un marqueur <strong>[IMG]</strong> dans le texte de ton article avec le bouton <strong>[Image]</strong> de la zone de formattage du texte de l'article.                        Il est possible de rajouter autant d'images que l'on veut. Il suffit de faire attention que le nombre de marqueurs [IMG] dans l'article correspond bien au nombre d'images rajoutées et sélectionnées ici.</p>                    <p>                        Si finalement tu veux supprimer une image, il suffit de cliquer sur le bouton <strong>[X]</strong> en face de cette image et d'enlever le marqueur de l'article où était censé arriver cette image.                    </p>                    </div>					<div id="cm-picture" class="infobox">						<input type="button" title="Ajouter une image" onclick="addImage();" value="Image +1"/>						<BR>					</div>					<div class="cm-separator-double"></div>                        <H3> Aperçu : </H3>                    <div class="cm-info-message">					<p> Afficher un aperçu avec le bouton ci-dessous pour vérifier le formattage de l'article. Cela permet de vérifier le placement des paragraphes, des images ainsi que de tous les élements qui enrchissent l'article.</p>                    </div>					<div class="divcenter"><input type="button" value="Afficher un aperçu..."  onclick="showPreview();"></div>                    <BR>                    <div class="cm-separator-double"></div>                        <input type="text" name="dontfuckwithme" class="cm-dontfuck">															<div class="divcenter"><input type="submit" value="Envoyer la publication"></div>	                    <BR>				</form>                </div>				<?php 					}				?>            </article>        </div>    </div></section><BR><BR><BR><script>var qcount = 0;var imgcount = 0;var vidcount = 0;function addQuote(){  qcount ++;  var quote = qcount;  var vParent = document.getElementById("cm-quote");  var vdiv = document.createElement("div");  vdiv.id = "div-quote" + quote.toString();  vdiv.className = "cm-new-element";  var vInput = document.createElement("input");  vInput.maxlength = 1024;  vInput.name= "quote[]";  vInput.size= 50;  vInput.type= "text";  vInput.id = "cm-id-quote-" + quote.toString();  vInput.placeholder = "\"...\"";    vdiv.appendChild(vInput);    vInput = document.createElement("input");  vInput.type="button";  vInput.placeholder = "Citation...";  vInput.value = "X";  vInput.onclick = function ()   {    var deleted = document.getElementById("div-quote" + quote.toString());  	this.parentElement.parentElement.removeChild(deleted);  	qcount --;  };  vdiv.appendChild(vInput);  vParent.appendChild(vdiv);  }function addImage(){  imgcount ++;  var num = imgcount;  var vParent = document.getElementById("cm-picture");  var vdiv = document.createElement("div");  vdiv.id = "div-image" + num.toString();  vdiv.className = "cm-new-element";  var vInput = document.createElement("input");  vInput.maxlength = 1024;  vInput.name= "image[]";  vInput.size= 50;  vInput.type= "file";  vInput.id = "cm-id-image-" + num.toString();    vdiv.appendChild(vInput);    vInput = document.createElement("input");  vInput.type="button";    vInput.value = "X";  vInput.onclick = function()   {  	var deleted = document.getElementById("div-image" + num.toString());  	this.parentElement.parentElement.removeChild(deleted);  	imgcount --;  };  vdiv.appendChild(vInput);  vParent.appendChild(vdiv);}function addVideo(){  vidcount ++;  var num = vidcount;  var vParent = document.getElementById("cm-video");  var vdiv = document.createElement("div");  vdiv.id = "div-video" + num.toString();  vdiv.className = "cm-new-element";  var vInput = document.createElement("input");  vInput.maxlength = 1024;  vInput.name= "video[]";  vInput.size= 50;  vInput.type= "text";  vInput.id = "cm-id-video-" + num.toString();  vInput.placeholder = "<iframe>....</iframe>";    vdiv.appendChild(vInput);    vInput = document.createElement("input");  vInput.type="button";    vInput.value = "X";  vInput.onclick = function ()   {  	var deleted = document.getElementById("div-video" + num.toString());  	this.parentElement.parentElement.removeChild(deleted);  	vidcount --;  };  vdiv.appendChild(vInput);  vParent.appendChild(vdiv);}function validateEmail(email) {    var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;    return re.test(email);}function formatText(tagStart, tagEnd) {   var Field = document.getElementById('id-article-text');   var val = Field.value;   var selectedText = val.substring(Field.selectionStart, Field.selectionEnd);   var beforeText = val.substring(0, Field.selectionStart);   var afterText = val.substring(Field.selectionEnd, val.length);   Field.value = beforeText + tagStart + selectedText +  tagEnd + afterText;}function validateForm() {      formulaire = document.getElementById("mainform");   todestroy = document.getElementById("todestroy");   topanchor = document.getElementById("topanchor");  if (todestroy != null)    formulaire.removeChild(todestroy);  newDiv = document.createElement("div");  newDiv.id = "todestroy"  newDiv.className = "cm-error-message";    var value = document.forms["mainform"]["titre"].value;    if (value == null || value == "")     {        newDiv.innerHTML ="<H3>Erreur : </H3>Vous devez renseigner un titre.";        formulaire.insertBefore(newDiv, formulaire.firstChild);        topanchor.scrollIntoView(true);        return false;    }        var value = document.forms["mainform"]["introduction"].value;    if (value == null || value == "")     {        newDiv.innerHTML ="<H3>Erreur : </H3>Vous devez écrire une introduction.";        formulaire.insertBefore(newDiv, formulaire.firstChild);        topanchor.scrollIntoView(true);        return false;    }    var value = document.forms["mainform"]["article"].value;    if (value == null || value == "")     {        newDiv.innerHTML ="<H3>Erreur : </H3>Vous devez rédiger votre article.";        formulaire.insertBefore(newDiv, formulaire.firstChild);        topanchor.scrollIntoView(true);        return false;    }    // Vérification des fichiers    if (document.getElementById("bandeauFrame").files.length == 0)    {        newDiv.innerHTML ="<H3>Erreur : </H3>Vous devez sélectionner une image pour le bandeau principal.";        formulaire.insertBefore(newDiv, formulaire.firstChild);        topanchor.scrollIntoView(true);        return false;    }    var articleText = document.forms["mainform"]["article"].value;    var count = 0;    var pos = articleText.indexOf("[IMG]");    while (pos != -1)     {        count++;        pos = articleText.indexOf("[IMG]",pos + 1);    }    if (imgcount != count)    {        newDiv.innerHTML ="<H3>Erreur : </H3>Le nombre de tag <strong>[IMG]</strong> de l'article ne correspond pas au nombre de visuels sélectionnés.";        formulaire.insertBefore(newDiv, formulaire.firstChild);        topanchor.scrollIntoView(true);        return false;     }    return true;}function showBackGround(){	var body = document.body;	html = document.documentElement;	var height = Math.max( body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight );	divInfo = document.getElementById('id-bg');	divInfo.style.height = height +  "px";	divInfo.style.visibility = "visible";}String.prototype.replaceAll = function(target, replacement) {  return this.split(target).join(replacement);};function showPreview(){	divInfo = document.getElementById('id-preview');	divInfo.style.visibility = "visible";	introarea = document.getElementById('id-intro-text');	divintro  = document.getElementById('cm-intro-text');	textarea = document.getElementById('id-article-text');	divtext  = document.getElementById('cm-preview-text'); 	 	text = textarea.value; 	text = text.replaceAll("[P]", "<p>"); 	text = text.replaceAll("[/P]", "</p>"); 	text = text.replaceAll("[T]", "<h2>"); 	text = text.replaceAll("[/T]", "</h2>"); 	text = text.replaceAll("[B]", "<strong>"); 	text = text.replaceAll("[/B]", "</strong>"); 	text = text.replaceAll("[IMG]", "<div class=\"cm-image-container\"><img src=\"/assets/generic.jpg\" alt=\"Aperçu\"/></div>"); 	text = text.replaceAll("[C]", "<blockquote>"); 	text = text.replaceAll("[/C]", "</blockquote>");    text = text.replaceAll("[F]", "<div class=\"infobox-container\">");    text = text.replaceAll("[/F]", "</div>"); 	text = text.replaceAll("[R]", "<BR>"); 	text = text.replaceAll("[-]", "<div class=\"separator\"></div>"); 	 	text = text.replaceAll("[URL=", "<a class=\"artlink\" target=\"blank\" href="); 	text = text.replaceAll("]]", ">"); 	text = text.replaceAll("[/URL]", "</a>"); 	text = text.replaceAll("[VIDEO]", "<div class=\"cm-image-container\"><div class=\"cm-video-wrapper\">"); 	text = text.replaceAll("[/VIDEO]", "</div></div>"); 		divtext.innerHTML = text;	divintro.innerHTML = introarea.value;				showBackGround();}function hideBoxes(){	divInfo = document.getElementById('id-bg');	divInfo.style.visibility = "hidden";	divInfo.style.height = 0 +  "px";	divInfo = document.getElementById('id-preview');	if (divInfo != null)		divInfo.style.visibility = "hidden";}</script></body><?php include 'footer.php'; ?></html>